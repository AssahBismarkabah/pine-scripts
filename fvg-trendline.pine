//@version=5
indicator("FVG Trailing(assah)", shorttitle = "FVG TS Final", overlay = true)

// This work is based on:
// Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// Â© LuxAlgo

//---------------------------------------------------------------------------------------------------------------------}
//User Inputs
//---------------------------------------------------------------------------------------------------------------------{

fvgLen = input.int(5, minval = 1,  title = "Unmitigated FVG Lookback")
smoothLen = input.int(9, minval = 1, title = "Smoothing Length")

ts2Tog = input.bool(false, title = "Reset on Cross") // Default to false for continuous line

bullColor =  input.color(#089981, title = " Bullish Color")
bearColor = input.color(#f23645, title = "Bearish Color")

//---------------------------------------------------------------------------------------------------------------------}
//Functions
//---------------------------------------------------------------------------------------------------------------------{

fz(_val,_standin) => _val > 0 ? _val : _standin


//---------------------------------------------------------------------------------------------------------------------}
//FVG Level Arrays
//---------------------------------------------------------------------------------------------------------------------{

var bull_lvls = array.new<float>(0)
var bear_lvls = array.new<float>(0)

//---------------------------------------------------------------------------------------------------------------------}
//Calculations
//---------------------------------------------------------------------------------------------------------------------{

// FVG Detection
if low > high[2] and close[1] > high[2]
    bull_lvls.push(high[2])

if high < low[2] and close[1] < low[2]
    bear_lvls.push(low[2])

// Array Size Management
if bull_lvls.size() > fvgLen
    bull_lvls.shift()

if bear_lvls.size() > fvgLen
    bear_lvls.shift()

// FVG Mitigation Detection
if bull_lvls.size() > 0
    for i = bull_lvls.size()-1 to 0
        if close < bull_lvls.get(i)
            bull_lvls.remove(i)

if bear_lvls.size() > 0
    for i = bear_lvls.size()-1 to 0
        if close > bear_lvls.get(i)
            bear_lvls.remove(i)

// Bars to calc SMAs
bull_bs = fz(ta.barssince(not na(bull_lvls.avg())),1)
bear_bs = fz(ta.barssince(not na(bear_lvls.avg())),1)

// Progressive SMAs 
csum = ta.cum(close)
// Calc starts at 1 when FVG array is empty and Maxes out at Smoothing Length
bull_sma = (csum - csum[math.min(bull_bs,smoothLen)]) / math.min(bull_bs,smoothLen)
bear_sma = (csum - csum[math.min(bear_bs,smoothLen)]) / math.min(bear_bs,smoothLen)

// Displayed Extreme Values (The FVG Base Lines)
bull_disp = ta.sma(nz(bull_lvls.avg(),bull_sma),smoothLen)
bear_disp = ta.sma(nz(bear_lvls.avg(),bear_sma),smoothLen)

var int dir = 0
if close > bear_disp
    dir := -1
if close < bull_disp
    dir := 1

// Actual Trailing Stop (TS) Logic
var int os = na
var float ts = na
float sr_crossings = na

// Trend State Determination
os := close > bear_disp ? 1 : close < bull_disp ? -1 : os
// Trailing Stop Calculation (Original, continuously trails)
ts := os > os[1] ? bull_disp : os < os[1] ? bear_disp : os == 1 ? math.max(bull_disp, ts) : math.min(bear_disp, ts)

// Optional Reset on Cross (This sets ts to na upon cross)
if ts2Tog
    if os == 1
        if close < ts
            sr_crossings := ts, ts := na
        else if close > bear_disp and na(ts)
            ts := bull_disp
    else if os == -1
        if close > ts
            sr_crossings := ts, ts := na
        else if close < bull_disp and na(ts)
            ts := bear_disp

//---------------------------------------------------------------------------------------------------------------------}
// Display: Final Corrected Single-Line Plotting (Using Global Series Calculation)
//---------------------------------------------------------------------------------------------------------------------{

// Determine the color of the Trailing Stop line based on the trend state (os)
var color ts_line_color = na
ts_line_color := os == 1 ? bullColor : bearColor

// 1. CALCULATE ALL POSSIBLE SERIES VALUES (Global Scope)
// If ts2Tog is OFF, the broken plots are NA. If ts2Tog is ON, the continuous plot is NA.
// We use nz(ts, ts[1]) for the broken lines to ensure continuity between non-na bars.

// Series for the broken Bullish line (only active when ts2Tog is ON and os is 1)
bull_plot_series = ts2Tog and os == 1 ? nz(ts,ts[1]) : na

// Series for the broken Bearish line (only active when ts2Tog is ON and os is -1)
bear_plot_series = ts2Tog and os == -1 ? nz(ts,ts[1]) : na

// Series for the single continuous line (only active when ts2Tog is OFF)
continuous_plot_series = not ts2Tog ? nz(ts) : na 


// 2. PLOT ALL SERIES (Global Scope is mandatory for plot())

// Plot 1: The single continuous line (Only visible when Reset on Cross is OFF)
plot(continuous_plot_series, title="Continuous Trailing Stop", color=ts_line_color, linewidth=2, style=plot.style_line)

// Plot 2: The broken Bullish line (Only visible when Reset on Cross is ON)
plot(bull_plot_series, title='Lower Trailing Stop (Breakable)', color=bullColor, linewidth=2, style=plot.style_linebr)

// Plot 3: The broken Bearish line (Only visible when Reset on Cross is ON)
plot(bear_plot_series, title='Upper Trailing Stop (Breakable)', color=bearColor, linewidth=2, style=plot.style_linebr)

// Plot 4: Trend change circles 
plot(os != os[1] ? ts : na, 'Trend Changes'
  , color = os == 1 ? bullColor : bearColor
  , style = plot.style_circles
  , linewidth = 1)
//---------------------------------------------------------------------------------------------------------------------}