//@version=5
indicator("ATS Dual Trend Indicator V6 (Corrected)", overlay=true, max_lines_count=500, max_labels_count=500)

// =============================================================================
//                             USER CONFIGURATION
// =============================================================================

// --- Global Settings ---
showBackground = input.bool(true, "Show Background Bias (Line B)", tooltip="Colors the background based on the faster, Line B trend direction.")
// --- End Global Settings ---


// --- Line A (Slower/Bias Trend - e.g., Daily/Weekly) ---
lineA_header = "--- Line A (HTF Bias) Configuration ---"
showLineA = input.bool(true, "Show Line A", group=lineA_header, tooltip="Toggle visibility for the slower trend line.")
lookbackA = input.int(8, "Lookback Window A", minval=5, maxval=20, group=lineA_header, tooltip="Lookback for Cluster Pivots (e.g., 5 for 1W, 8 for 1D)")
smoothingA = input.int(2, "Smoothing Length A", minval=1, maxval=10, group=lineA_header, tooltip="EMA smoothing period. Set to 1 for no smoothing.")
colorA = input.color(color.new(color.white, 0), "Color A", group=lineA_header)
showTrendChangeDotsA = input.bool(false, "Show Trend Change Dots A (Bias Flip)", group=lineA_header, tooltip="Marks major bias flips on the slower Line A.")

// --- Line B (Faster/Entry Trend - e.g., 4H/30M) ---
lineB_header = "--- Line B (LTF Entry) Configuration ---"
showLineB = input.bool(true, "Show Line B", group=lineB_header, tooltip="Toggle visibility for the faster trend line.")
lookbackB = input.int(15, "Lookback Window B", minval=5, maxval=20, group=lineB_header, tooltip="Lookback for Cluster Pivots (e.g., 15 for 30M)")
smoothingB = input.int(4, "Smoothing Length B", minval=1, maxval=10, group=lineB_header, tooltip="EMA smoothing period. Set to 1 for no smoothing.")
colorB = input.color(color.new(#00BFFF, 0), "Color B", group=lineB_header) // Default Blue for contrast
showTrendChangeDotsB = input.bool(true, "Show Trend Change Dots B (Entry Flip)", group=lineB_header, tooltip="Marks entry/exit flips on the faster Line B.")


// =============================================================================
//                             CORE CALCULATION FUNCTION
// =============================================================================
// Encapsulates the entire ATS logic to be run twice independently

f_calculateATS(lookbackWindow, smoothingLength) =>
    // --- 1. STATE VARIABLES ---
    var trendDirection = "Neutral"
    var float trendLine = na
    var float lastFVGSupport = na
    var float lastFVGResistance = na
    var float lastClusterSupport = na
    var float lastClusterResistance = na
    var int barsInTrend = 0

    // --- 2. 3-CANDLE FVG DETECTION (CRITICAL FIX) ---
    // Standard 3-Bar FVG Definition (V6 logic was inverted)
    // Bullish FVG: Bar 1 High (high[2]) is lower than Bar 3 Low (low)
    bool bullishFVG = high[2] < low
    // Bearish FVG: Bar 1 Low (low[2]) is higher than Bar 3 High (high)
    bool bearishFVG = low[2] > high
    
    // Store FVG levels
    if bullishFVG
        lastFVGSupport := high[2] // The top of the bullish FVG gap
    if bearishFVG
        lastFVGResistance := low[2] // The bottom of the bearish FVG gap

    // --- 3. CLUSTER PIVOT DETECTION ---
    pivotLow = ta.pivotlow(low, lookbackWindow, lookbackWindow)
    pivotHigh = ta.pivothigh(high, lookbackWindow, lookbackWindow)
    
    // Update last cluster levels persistently
    if not na(pivotLow)
        lastClusterSupport := pivotLow
    if not na(pivotHigh)
        lastClusterResistance := pivotHigh

    // Store previous trend for change detection
    string prevTrendDirection = trendDirection[1]

    // --- 4. TREND ESTABLISHMENT (State Machine) ---
    // (CRITICAL FIX) Now references the correctly defined FVG variables
    if bullishFVG and trendDirection != "Up"
        trendDirection := "Up"
        barsInTrend := 0
        trendLine := na(lastFVGSupport) ? low : lastFVGSupport
        
    if bearishFVG and trendDirection != "Down"
        trendDirection := "Down"
        barsInTrend := 0
        trendLine := na(lastFVGResistance) ? high : lastFVGResistance

    // Increment bars in trend (for whipsaw prevention)
    if trendDirection == prevTrendDirection
        barsInTrend += 1

    // --- 5. HIERARCHICAL TREND LINE UPDATE ---
    // (CRITICAL FIX) Removed V6 "Smooth Transition" logic.
    // That logic is unsafe as it makes the stop-loss level (trendLine) lag the true pivot.
    // We will rely on the external EMA (smoothingLength) for visual smoothing only.
    
    if trendDirection == "Up"
        float newTrendLine = na(trendLine[1]) ? lastFVGSupport : nz(trendLine[1])
        if not na(lastFVGSupport) and lastFVGSupport > newTrendLine
            newTrendLine := lastFVGSupport
        if not na(lastClusterSupport) and lastClusterSupport > newTrendLine
            newTrendLine := lastClusterSupport
        trendLine := newTrendLine // Direct assignment is correct

    if trendDirection == "Down"
        float newTrendLine = na(trendLine[1]) ? lastFVGResistance : nz(trendLine[1])
        if not na(lastFVGResistance) and lastFVGResistance < newTrendLine
            newTrendLine := lastFVGResistance
        if not na(lastClusterResistance) and lastClusterResistance < newTrendLine
            newTrendLine := lastClusterResistance
        trendLine := newTrendLine // Direct assignment is correct

    // --- 6. TREND INVALIDATION LOGIC (CRITICAL FIX) ---
    int minBarsInTrend = 3  // Whipsaw prevention
    
    if trendDirection == "Up" and close < trendLine and barsInTrend >= minBarsInTrend
        // (CRITICAL FIX) Only flip if we have a *bearish* FVG confirmation
        if bearishFVG
            trendDirection := "Down"
            trendLine := high
            lastFVGSupport := na
            lastClusterSupport := na
            barsInTrend := 0

    if trendDirection == "Down" and close > trendLine and barsInTrend >= minBarsInTrend
        // (CRITICAL FIX) Only flip if we have a *bullish* FVG confirmation
        if bullishFVG
            trendDirection := "Up"
            trendLine := low
            lastFVGResistance := na
            lastClusterResistance := na
            barsInTrend := 0

    // --- 7. SMOOTHING (EXTERNAL) ---
    // This is the correct, safe way to handle visual smoothing
    smoothedTrendLine = ta.ema(trendLine, smoothingLength)
    
    // --- 8. RETURN VALUES ---
    [smoothedTrendLine, trendDirection, prevTrendDirection]


// =============================================================================
//                             EXECUTION
// =============================================================================

// Run the function for Line A
[smoothedTrendLineA, trendDirectionA, prevTrendDirectionA] = f_calculateATS(lookbackA, smoothingA)

// Run the function for Line B
[smoothedTrendLineB, trendDirectionB, prevTrendDirectionB] = f_calculateATS(lookbackB, smoothingB)


// =============================================================================
//                             VISUALIZATION
// =============================================================================

// --- Line A Plot (HTF Bias) ---
plot(showLineA ? smoothedTrendLineA : na, "ATS Line A", colorA, 2, plot.style_line)

// --- Line B Plot (LTF Entry) ---
plot(showLineB ? smoothedTrendLineB : na, "ATS Line B", colorB, 2, plot.style_line)

// --- Background Color (Uses faster Line B bias) ---
bgcolor(showBackground ? (trendDirectionB == "Up" ? color.new(color.green, 95) : trendDirectionB == "Down" ? color.new(color.red, 95) : na) : na)

// --- Trend Change Dots for Line A (Major Bias Flip) ---
plotshape(showLineA and showTrendChangeDotsA and trendDirectionA != prevTrendDirectionA ? smoothedTrendLineA : na, 
          title="Line A Trend Flip", 
          style=shape.cross, 
          location=location.absolute,
          color=trendDirectionA == "Up" ? color.green : color.red, 
          size=size.small)

// --- Trend Change Dots for Line B (Entry Flip) ---
plotshape(showLineB and showTrendChangeDotsB and trendDirectionB != prevTrendDirectionB ? smoothedTrendLineB : na, 
          title="Line B Trend Flip", 
          style=shape.circle, 
          location=location.absolute,
          color=trendDirectionB == "Up" ? color.green : color.red, 
          size=size.small)

// =============================================================================
//                             ALERTS
// =============================================================================
// Alerts are now based on Line B (the entry line)

// Trend direction change alerts
alertcondition(trendDirectionB != prevTrendDirectionB, "Line B Trend Change", "Line B direction changed to {{trendDirectionB}}")

// Trend line break alerts (invalidation)
alertcondition(trendDirectionB == "Up" and close < smoothedTrendLineB, "Line B Bullish Trend Break", "Price broke below Line B (Bullish Trend Invalidation)")
alertcondition(trendDirectionB == "Down" and close > smoothedTrendLineB, "Line B Bearish Trend Break", "Price broke above Line B (Bearish Trend Invalidation)")

// Multi-Timeframe Confirmation Alert: Optional, very powerful signal!
alertcondition(trendDirectionA == "Up" and trendDirectionB == "Up", "HTF/LTF BULLISH Alignment", "Both Line A and Line B are Bullish (Strong Long Signal)")
alertcondition(trendDirectionA == "Down" and trendDirectionB == "Down", "HTF/LTF BEARISH Alignment", "Both Line A and Line B are Bearish (Strong Short Signal)")

// =============================================================================
//                             DOCUMENTATION
// =============================================================================
// This indicator provides two independent ATS Trend lines with separate configurations
// for powerful Multi-Timeframe (MTF) analysis.
//
// VERSION 6 (Corrected):
// - Fixes inverted FVG logic from the original V6 script.
// - Removes unsafe internal smoothing ("transitionSpeed") that compromised the stop-loss level.
// - Whipsaw Prevention: Requires an FVG to confirm a trend flip, preventing flips in chop.
//
// USAGE:
// 1. Line A (Slower): Set for your overall BIAS (e.g., 1D settings).
// 2. Line B (Faster): Set for your ENTRY/EXIT timing (e.g., 4H settings).
//
// - LONG SIGNAL: Line A is Green/Up AND Line B flips/stays Green/Up.
// - SHORT SIGNAL: Line A is Red/Down AND Line B flips/stays Red/Down.
//
// Line B controls the Background color and Trend Flip Dots by default.