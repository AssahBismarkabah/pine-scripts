//@version=5
indicator("ATS-Style Inefficiency Tracker (Smoothed Step)", overlay=true)

// ====================================================================
// 1. INPUTS & CONFIGURATION
// ====================================================================

// --- Timeframe Presets ---
preset = input.string("Manual", title="Timeframe Optimization Preset", 
     options=["Manual", "1W (Swing)", "1D (Swing)", "4H (Intraday)", "30M (Tactical)", "15M (Scalp)"],
     tooltip="Automatically sets optimal 'Survival Bars' (filter) and 'Smoothness' (lag) based on your selected timeframe.")

// --- Manual Configuration Inputs ---
// These are only used if Preset is set to "Manual"
manual_group_size = input.int(5, title="Survival Bars (Manual Filter)", minval=1)
manual_smooth_period = input.int(3, title="Trend Line Smoothness (Manual)", minval=1)

// --- Optimal Preset Logic ---
var int preset_group_size = 0
var int preset_smooth_period = 0

if preset == "1W (Swing)"
    preset_group_size := 3
    preset_smooth_period := 5
else if preset == "1D (Swing)"
    preset_group_size := 5
    preset_smooth_period := 3
else if preset == "4H (Intraday)"
    preset_group_size := 8
    preset_smooth_period := 3
else if preset == "30M (Tactical)"
    preset_group_size := 12
    preset_smooth_period := 5
else if preset == "15M (Scalp)"
    preset_group_size := 15
    preset_smooth_period := 8
else
    // "Manual" or any other value defaults to the manual inputs
    preset_group_size := manual_group_size
    preset_smooth_period := manual_smooth_period

// Final values to be used in the logic
group_size = preset_group_size
smooth_period = preset_smooth_period

// Line Color Configuration
long_color = color.new(#ffffff, 0) // White (assuming dark background)
short_color = color.new(#494949, 0) // Dark Gray (assuming dark background)

// ====================================================================
// 2. STATE MANAGEMENT (The Core Logic)
// ====================================================================

var int directionalBias = 0
var float currentLineLevel = na
var int startBarIndex = na

// ====================================================================
// 3. FVG (3-CANDLE) DETECTION & LEVEL (History Operator Shifted)
// ====================================================================

fvg_offset = group_size

// Standard 3-Bar FVG Detection logic, shifted back by 'group_size' bars
isBullishFVG_past = high[fvg_offset + 2] < low[fvg_offset] 
isBearishFVG_past = low[fvg_offset + 2] > high[fvg_offset] 

// The level for the FVG is the boundary that must be protected
pastBullishLevel = isBullishFVG_past ? high[fvg_offset + 2] : na 
pastBearishLevel = isBearishFVG_past ? low[fvg_offset + 2] : na  

// ====================================================================
// 4. GROUP SEPARATION (FVG FILL) FILTER (Real-Time Fix)
// ====================================================================

bullishFVG_survived = true
bearishFVG_survived = true

// Check if the FVG has been mitigated in the subsequent 'group_size' bars (0 to fvg_offset - 1)
for i = 0 to fvg_offset - 1
    // If price breaks below the bullish FVG level, it is mitigated
    if not na(pastBullishLevel) and low[i] < pastBullishLevel
        bullishFVG_survived := false
    // If price breaks above the bearish FVG level, it is mitigated
    if not na(pastBearishLevel) and high[i] > pastBearishLevel
        bearishFVG_survived := false

isConfirmedBullishFVG = isBullishFVG_past and bullishFVG_survived
isConfirmedBearishFVG = isBearishFVG_past and bearishFVG_survived

confirmedBullishLevel = isConfirmedBullishFVG ? pastBullishLevel : na
confirmedBearishLevel = isConfirmedBearishFVG ? pastBearishLevel : na

// ====================================================================
// 5. TREND STATE MACHINE (Hold, Step, Flip)
// ====================================================================

// --- FLIP LOGIC (Custom Rule 4: Trailing Stop Break) ---
// If price closes past the current stop level, reset to Neutral
if directionalBias == 1 // LONG BIAS
    if close < currentLineLevel
        directionalBias := 0 // Flip to NEUTRAL
        currentLineLevel := na 
        
else if directionalBias == -1 // SHORT BIAS
    if close > currentLineLevel
        directionalBias := 0 // Flip to NEUTRAL
        currentLineLevel := na 

// --- STEP/ENTRY LOGIC (Custom Rule 3: FVG Confirmation) ---

// 1. New Long Entry/Step Up
if isConfirmedBullishFVG
    if directionalBias != -1 // Cannot enter long if currently short
        if directionalBias == 0 or confirmedBullishLevel > currentLineLevel // Entering New Long Trend or Stepping Up
            directionalBias := 1
            currentLineLevel := confirmedBullishLevel
            startBarIndex := bar_index - group_size // Mark the bar where the FVG was confirmed
            
// 2. New Short Entry/Step Down
if isConfirmedBearishFVG
    if directionalBias != 1 // Cannot enter short if currently long
        if directionalBias == 0 or confirmedBearishLevel < currentLineLevel // Entering New Short Trend or Stepping Down
            directionalBias := -1
            currentLineLevel := confirmedBearishLevel
            startBarIndex := bar_index - group_size // Mark the bar where the FVG was confirmed

// ====================================================================
// 6. VISUALIZATION & SMOOTH PLOTTING (The Fix)
// ====================================================================

// Hold the confirmed level and bias state
finalLevel = ta.valuewhen(not na(currentLineLevel), currentLineLevel, 0)
finalBias = ta.valuewhen(directionalBias != 0, directionalBias, 0)

// Apply smoothing (WMA) for the gradual step transition
smoothedLevel = ta.wma(finalLevel, smooth_period)

// Determine plot color
plotColor = finalBias == 1 ? long_color : finalBias == -1 ? short_color : na

// Plot the smoothed, stepping line
plot(smoothedLevel, title="Smoothed ATS Trend Line", color=plotColor, linewidth=2, trackprice=true)
     
// --- Display Bias Status in a Table ---

var table infoTable = table.new(position.top_right, 1, 1, bgcolor=color.black, border_width=1)
if barstate.islast
    color displayColor = finalBias == 1 ? color.new(color.lime, 0) : finalBias == -1 ? color.new(color.red, 0) : color.gray
    string statusText = finalBias == 1 ? "LONG DB" : finalBias == -1 ? "SHORT DB" : "NEUTRAL"
    
    table.cell(infoTable, 0, 0, "ATS Bias: " + statusText, text_color=color.white, bgcolor=displayColor)