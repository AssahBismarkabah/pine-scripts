//@version=5
indicator("ATS-Style Inefficiency Tracker (Smoothed Step)", overlay=true)

// ====================================================================
// 1. INPUTS & CONFIGURATION
// ====================================================================

// Group Size (Custom Rule 2: Filter)
group_size = input.int(5, title="Survival Bars (Group Size)", minval=1)

// Smoothing Period (New Input for Visuals)
// Controls how quickly the line visually moves to the new level after a step is confirmed.
smooth_period = input.int(3, title="Trend Line Smoothness", minval=1, tooltip="Higher value makes the line transition slower and smoother.")

// Line Color Configuration
long_color = color.new(#ffffff, 0) // White (assuming dark background)
short_color = color.new(#494949, 0) // Dark Gray (assuming dark background)

// ====================================================================
// 2. STATE MANAGEMENT (The Core Logic)
// ====================================================================

var int directionalBias = 0
var float currentLineLevel = na
var int startBarIndex = na

// ====================================================================
// 3. FVG (3-CANDLE) DETECTION & LEVEL (History Operator Shifted)
// ====================================================================

fvg_offset = group_size

// Standard 3-Bar FVG Detection logic, shifted back by 'group_size' bars
isBullishFVG_past = high[fvg_offset + 2] < low[fvg_offset] 
isBearishFVG_past = low[fvg_offset + 2] > high[fvg_offset] 

// The level for the FVG is the boundary that must be protected
pastBullishLevel = isBullishFVG_past ? high[fvg_offset + 2] : na 
pastBearishLevel = isBearishFVG_past ? low[fvg_offset + 2] : na  

// ====================================================================
// 4. GROUP SEPARATION (FVG FILL) FILTER (Real-Time Fix)
// ====================================================================

bullishFVG_survived = true
bearishFVG_survived = true

// Check if the FVG has been mitigated in the subsequent 'group_size' bars (0 to fvg_offset - 1)
for i = 0 to fvg_offset - 1
    // If price breaks below the bullish FVG level, it is mitigated
    if not na(pastBullishLevel) and low[i] < pastBullishLevel
        bullishFVG_survived := false
    // If price breaks above the bearish FVG level, it is mitigated
    if not na(pastBearishLevel) and high[i] > pastBearishLevel
        bearishFVG_survived := false

isConfirmedBullishFVG = isBullishFVG_past and bullishFVG_survived
isConfirmedBearishFVG = isBearishFVG_past and bearishFVG_survived

confirmedBullishLevel = isConfirmedBullishFVG ? pastBullishLevel : na
confirmedBearishLevel = isConfirmedBearishFVG ? pastBearishLevel : na

// ====================================================================
// 5. TREND STATE MACHINE (Hold, Step, Flip)
// ====================================================================

// --- FLIP LOGIC (Custom Rule 4: Trailing Stop Break) ---
// If price closes past the current stop level, reset to Neutral
if directionalBias == 1 // LONG BIAS
    if close < currentLineLevel
        directionalBias := 0 // Flip to NEUTRAL
        currentLineLevel := na 
        
else if directionalBias == -1 // SHORT BIAS
    if close > currentLineLevel
        directionalBias := 0 // Flip to NEUTRAL
        currentLineLevel := na 

// --- STEP/ENTRY LOGIC (Custom Rule 3: FVG Confirmation) ---

// 1. New Long Entry/Step Up
if isConfirmedBullishFVG
    if directionalBias != -1 // Cannot enter long if currently short
        if directionalBias == 0 or confirmedBullishLevel > currentLineLevel // Entering New Long Trend or Stepping Up
            directionalBias := 1
            currentLineLevel := confirmedBullishLevel
            startBarIndex := bar_index - group_size // Mark the bar where the FVG was confirmed
            
// 2. New Short Entry/Step Down
if isConfirmedBearishFVG
    if directionalBias != 1 // Cannot enter short if currently long
        if directionalBias == 0 or confirmedBearishLevel < currentLineLevel // Entering New Short Trend or Stepping Down
            directionalBias := -1
            currentLineLevel := confirmedBearishLevel
            startBarIndex := bar_index - group_size // Mark the bar where the FVG was confirmed

// ====================================================================
// 6. VISUALIZATION & SMOOTH PLOTTING (The Fix)
// ====================================================================

// Hold the confirmed level and bias state
finalLevel = ta.valuewhen(not na(currentLineLevel), currentLineLevel, 0)
finalBias = ta.valuewhen(directionalBias != 0, directionalBias, 0)

// Apply smoothing (WMA) for the gradual step transition
smoothedLevel = ta.wma(finalLevel, smooth_period)

// Determine plot color
plotColor = finalBias == 1 ? long_color : finalBias == -1 ? short_color : na

// Plot the smoothed, stepping line
plot(smoothedLevel, title="Smoothed ATS Trend Line", color=plotColor, linewidth=2, trackprice=true)
     
// --- TREND CHANGE / FVG Confirmation DOTS (FIXED for visibility) ---
// We increase the size to 'size.small' and offset the position slightly for visibility
// relative to the main line plot.

// Calculation for the small vertical offset
f_offset_level(level, direction) => 
    float offset = syminfo.mintick * 10 // A small offset based on tick size (adjust 10 as needed)
    direction == 1 ? level + offset : level - offset

// Bullish Confirmed FVG Dot (offset slightly above the level)
plotshape(isConfirmedBullishFVG ? f_offset_level(confirmedBullishLevel, 1) : na,
     style=shape.circle,
     location=location.absolute,
     offset=-group_size,
     color=color.green,
     size=size.tiny,
     title="Bull FVG Signal")
     
// Bearish Confirmed FVG Dot (offset slightly below the level)
plotshape(isConfirmedBearishFVG ? f_offset_level(confirmedBearishLevel, -1) : na,
     style=shape.circle,
     location=location.absolute,
     offset=-group_size,
     color=color.red,
     size=size.tiny,
     title="Bear FVG Signal")
     
// --- Display Bias Status in a Table ---

var table infoTable = table.new(position.top_right, 1, 1, bgcolor=color.black, border_width=1)
if barstate.islast
    color displayColor = finalBias == 1 ? color.new(color.lime, 0) : finalBias == -1 ? color.new(color.red, 0) : color.gray
    string statusText = finalBias == 1 ? "LONG DB" : finalBias == -1 ? "SHORT DB" : "NEUTRAL"
    
    table.cell(infoTable, 0, 0, "ATS Bias: " + statusText, text_color=color.white, bgcolor=displayColor)