//@version=5
indicator("ATS-Style Inefficiency Tracker (Smoothed Step)", overlay=true)

// ====================================================================
// 1. INPUTS & CONFIGURATION
// ====================================================================

// Group Size (Custom Rule 2: Filter)
group_size = input.int(5, title="Survival Bars (Group Size)", minval=1)

// Smoothing Period (New Input for Visuals)
// Controls how quickly the line visually moves to the new level after a step is confirmed.
smooth_period = input.int(3, title="Trend Line Smoothness", minval=1, tooltip="Higher value makes the line transition slower and smoother.")

// Line Color Configuration
long_color = color.new(#ffffff, 0) // White (assuming dark background)
short_color = color.new(#494949, 0) // Dark Gray (assuming dark background)

// ====================================================================
// 2. STATE MANAGEMENT (The Core Logic)
// ====================================================================

var int directionalBias = 0
var float currentLineLevel = na
var int startBarIndex = na

// ====================================================================
// 3. FVG (3-CANDLE) DETECTION & LEVEL (History Operator Shifted)
// ====================================================================

fvg_offset = group_size

isBullishFVG_past = low[fvg_offset] > high[fvg_offset + 2]
isBearishFVG_past = high[fvg_offset] < low[fvg_offset + 2]

pastBullishLevel = isBullishFVG_past ? high[fvg_offset + 2] : na 
pastBearishLevel = isBearishFVG_past ? low[fvg_offset + 2] : na  

// ====================================================================
// 4. GROUP SEPARATION (FVG FILL) FILTER (Real-Time Fix)
// ====================================================================

bullishFVG_survived = true
bearishFVG_survived = true

for i = 0 to fvg_offset - 1
    if not na(pastBullishLevel) and low[i] < pastBullishLevel
        bullishFVG_survived := false
    if not na(pastBearishLevel) and high[i] > pastBearishLevel
        bearishFVG_survived := false

isConfirmedBullishFVG = isBullishFVG_past and bullishFVG_survived
isConfirmedBearishFVG = isBearishFVG_past and bearishFVG_survived

confirmedBullishLevel = isConfirmedBullishFVG ? pastBullishLevel : na
confirmedBearishLevel = isConfirmedBearishFVG ? pastBearishLevel : na

// ====================================================================
// 5. TREND STATE MACHINE (Hold, Step, Flip)
// ====================================================================

// --- FLIP LOGIC (Custom Rule 4) ---
if directionalBias == 1 // LONG BIAS
    if close < currentLineLevel
        directionalBias := 0 // Flip to NEUTRAL
        currentLineLevel := na 
        
else if directionalBias == -1 // SHORT BIAS
    if close > currentLineLevel
        directionalBias := 0 // Flip to NEUTRAL
        currentLineLevel := na 

// --- STEP/ENTRY LOGIC (Custom Rule 3) ---

// 1. New Long Entry/Step Up
if isConfirmedBullishFVG
    if directionalBias == 0 // Entering New Long Trend
        directionalBias := 1
        currentLineLevel := confirmedBullishLevel
        startBarIndex := bar_index - group_size 
    else if directionalBias == 1 // Stepping Up
        if confirmedBullishLevel > currentLineLevel 
            currentLineLevel := confirmedBullishLevel
            startBarIndex := bar_index - group_size
            
// 2. New Short Entry/Step Down
if isConfirmedBearishFVG
    if directionalBias == 0 // Entering New Short Trend
        directionalBias := -1
        currentLineLevel := confirmedBearishLevel
        startBarIndex := bar_index - group_size 
    else if directionalBias == -1 // Stepping Down
        if confirmedBearishLevel < currentLineLevel
            currentLineLevel := confirmedBearishLevel
            startBarIndex := bar_index - group_size

// ====================================================================
// 6. VISUALIZATION & SMOOTH PLOTTING (The Fix)
// ====================================================================

// Use ta.valuewhen to ensure the current line level holds its value until 
// a new confirmation is made, even if the confirmation signal is temporary.
finalLevel = ta.valuewhen(not na(currentLineLevel), currentLineLevel, 0)
finalBias = ta.valuewhen(directionalBias != 0, directionalBias, 0)

// Apply smoothing to the final level to create the gradual step transition
// Use WMA for a visually smooth curve, which better matches the proprietary feel.
smoothedLevel = ta.wma(finalLevel, smooth_period)

// Determine plot color
plotColor = finalBias == 1 ? long_color : finalBias == -1 ? short_color : na

// Plot the smoothed, stepping line
plot(smoothedLevel, title="Smoothed ATS Trend Line", color=plotColor, linewidth=2, trackprice=true)
     
// --- Debugging/Visualization of FVG Signals ---

// Plot a small dot where the FVG was *originally formed*
plotshape(isConfirmedBullishFVG or isConfirmedBearishFVG, 
     style=shape.circle, 
     location=location.bottom, 
     offset=group_size, 
     color=isConfirmedBullishFVG ? color.green : color.red, 
     size=size.tiny, 
     title="Confirmed FVG Signal")
     
// --- Display Bias Status in a Table ---

var table infoTable = table.new(position.top_right, 1, 1, bgcolor=color.black, border_width=1)
if barstate.islast
    color displayColor = finalBias == 1 ? color.new(color.lime, 0) : finalBias == -1 ? color.new(color.red, 0) : color.gray
    string statusText = finalBias == 1 ? "LONG DB" : finalBias == -1 ? "SHORT DB" : "NEUTRAL"
    
    table.cell(infoTable, 0, 0, "ATS Bias: " + statusText, text_color=color.white, bgcolor=displayColor)